<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>添加图片</title>
	<script src="/static/admin/js/jquery1.8.3.min.js"></script>
	<script src="/static/admin/assets/layui.js"></script>
	<link rel="stylesheet" href="/static/admin/assets/css/layui.css">
	
</head>
<body>
	<div class="layui-content">
        <div class="layui-row">
            <div class="layui-card">
                <div class="layui-card-header">添加图片 &nbsp;&nbsp;&nbsp;<i class="layui-icon" onclick='location.href=location.href'>&#xe666;</i></div>
                <form class="layui-form layui-card-body" action="" id="form">
                  <div class="layui-form-item">
				    <label class="layui-form-label">选择图片</label>
				    <div class="layui-input-inline">
					    <button type="button" class="layui-btn" id="upload">
					  		<i class="layui-icon">&#xe67c;</i>上传图片
						</button>
				    </div>
				    <div class="layui-form-mid layui-word-aux"></div>
				 </div>
				 <div class="layui-form-item">
				    <label class="layui-form-label">图片预览</label>
				    <div class="layui-input-block imgbox">
				    	
				    </div>
				 </div>
                 <div class="layui-form-item">
                    <label class="layui-form-label">图片介绍</label>
                    <div class="layui-input-block">
						<textarea name="slide_desc" required lay-verify="required" placeholder="请输入" class="layui-textarea"></textarea>
                    </div>
                  </div>
                  <div class="layui-form-item">
                    <label class="layui-form-label">是否显示</label>
                    <div class="layui-input-block">
                      <input type="checkbox" name="switch" lay-skin="switch" lay-text="显示|隐藏" checked>
                    </div>
                  </div>
                  <div class="layui-form-item">
                    <div class="layui-input-block">
                      <button class="layui-btn layui-btn-blue" type="submit">立即提交</button>
                      <button type="reset" class="layui-btn layui-btn-primary" >重置</button>
                    </div>
                  </div>
                </form>  
            </div>
        </div>
    </div>
    <script src="/static/admin/assets/layui.all.js"></script>
    {include file="public/trumbowyg"}
    {include file="public/validate"}
    <script>
    	function layer_close(){
		  var index = parent.layer.getFrameIndex(window.name);
		  parent.location.reload();
		  parent.layer.close(index);
		}
		layui.use('upload', function(){		
			var upload = layui.upload;
					  //执行实例
			var uploadInst = upload.render({
				elem: '#upload' //绑定元素
				,url: "{:url('admin/Slide/upload')}",//上传接口
				accept:"images",
				field:"img",
				done:function(res,index,load){
					if (res.code==1) {
						var str="<span class='box'>";
						str+='<img src="'+/uploads/+res.imginfo+'">';
						str+="<i class='layui-icon'>&#x1007;</i>";
						str+='<input type="hidden" name="img" value="'+/uploads/+res.imginfo+'">';
						str+="</span>";
						$(".imgbox").append(str);
					}
				}
			});
			//删除图片
			$(".box i").live("click",function(){
				//页面中，该图片消失
				var imginfo = $(this).prev().attr('src');
				var obj = $(this).parent();
				//服务器中相应图片删除
				$.ajax({
					type:'get',
					url:"{:url('admin/system/delimg')}",
					data:{imginfo:imginfo},
					dataType:"json",
					success:function(res){
						if (res.code==1) {
							obj.remove();
							layer.msg(res.msg,{icon:1,time:1500})
						}
					}
				})
			})
		});
    	layui.use('layer',function(){
			var layer = layui.layer;
			layer.config({
	          icon:2,
	          tips:[2,"#123456"],
	          time:1000
	        })
			$("#form").validate({
				submitHandler:function(form){
					var newscontentval = $("textarea[name=slide_desc]").val();
		            if ($('.imgbox').find('span').length==0) {
						layer.open({
							type:0,
							title:'注意',
							content:'请添加图片',
							icon:2
						});
						return false;
					}
		            if(newscontentval==''){
		              layer.tips('内容不能为空','textarea[name=slide_desc]');
		              return false;
		            }     

					$(form).ajaxSubmit({
						type:"post",
						url:"{:url('admin/Slide/slideadd')}",
						dataType:'json',
						success:function(res){
							//alert(res);
							if (res.code==1) {
								layer.msg("添加成功",{icon:1,time:1500},function(index){
									layer_close();
								})
							}else{
								layer.msg("添加失败",{icon:2,time:1500},function(index){
									
								})
							}
						}
					})
				},
				errorPlacement:function(error,element){
					element.parent().next().html(error);
				}
			})
		})
    </script>
</body>
</html>